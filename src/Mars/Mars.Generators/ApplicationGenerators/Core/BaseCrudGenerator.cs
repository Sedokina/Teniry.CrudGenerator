using System;
using System.IO;
using System.Reflection;
using System.Text;
using Mars.Generators.ApplicationGenerators.Core.EntitySchemaCore;
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.CSharp;
using Microsoft.CodeAnalysis.Text;
using Scriban;
using Scriban.Runtime;

namespace Mars.Generators.ApplicationGenerators.Core;

public abstract class BaseGenerator
{
    protected readonly string AutogeneratedFileText;
    protected readonly GeneratorExecutionContext Context;

    protected BaseGenerator(GeneratorExecutionContext context, string autogeneratedFileText)
    {
        AutogeneratedFileText = autogeneratedFileText;
        Context = context;
    }

    public abstract void RunGenerator();

    protected virtual void WriteFile(string templatePath, object model, string className)
    {
        var template = ReadTemplate(templatePath);

        var sourceCode = AutogeneratedFileText + "\n" + template.Render(model);
        var result = CSharpSyntaxTree.ParseText(SourceText.From(sourceCode.Trim(), Encoding.UTF8))
            .GetRoot()
            .NormalizeWhitespace()
            .SyntaxTree
            .GetText();

        Context.AddSource($"{className}.g.cs", result);
    }

    internal Template ReadTemplate(string templatePath)
    {
        return Template.Parse(GetEmbeddedResource(templatePath, GetType().Assembly));
    }

    private static string GetEmbeddedResource(string path, Assembly assembly)
    {
        using var stream = assembly.GetManifestResourceStream(path);
        using var streamReader = new StreamReader(stream ?? throw new InvalidOperationException());
        return streamReader.ReadToEnd();
    }
}

public abstract class BaseCrudGenerator<TConfiguration> : BaseGenerator
    where TConfiguration : IQueryCommandGeneratorConfiguration
{
    protected readonly EntityScheme EntityScheme;
    protected readonly DbContextScheme DbContextScheme;
    protected readonly TConfiguration Configuration;
    protected readonly ISymbol Symbol;
    protected readonly string BusinessLogicNamespace;
    public string EndpointNamespace { get; set; }
    public EndpointMap EndpointMap { get; set; }

    protected BaseCrudGenerator(
        GeneratorExecutionContext context,
        ISymbol symbol,
        TConfiguration configuration,
        EntityScheme entityScheme,
        DbContextScheme dbContextScheme)
        : base(context, configuration.FullConfiguration.AutogeneratedFileText)
    {
        DbContextScheme = dbContextScheme;
        EntityScheme = entityScheme;
        Configuration = configuration;
        Symbol = symbol;
        BusinessLogicNamespace = Configuration.FullConfiguration.BusinessLogicNamespaceBasePath.GetNamespacePath(
            EntityScheme.EntityName,
            Symbol.ContainingAssembly.Name,
            Configuration.FullConfiguration.FeatureNameConfiguration,
            configuration.FunctionNameConfiguration);
        EndpointNamespace = Configuration.FullConfiguration.EndpointsNamespaceBasePath.GetNamespacePath(
            EntityScheme.EntityName,
            Symbol.ContainingAssembly.Name);
    }

    protected override void WriteFile(string templatePath, object model, string className)
    {
        var template = ReadTemplate(templatePath);

        var baseProps = new ScriptObject();
        baseProps.Import(new
        {
            EntityName = EntityScheme.EntityName.ToString(),
            PluralEntityName = EntityScheme.EntityName.PluralName,
            EntityNamespace = EntityScheme.EntityNamespace,
            BusinessLogicNamespace = BusinessLogicNamespace,
            EndpointNamespace = EndpointNamespace,
            EntityTitle = EntityScheme.EntityTitle.ToString(),
            PluralEntityTitle = EntityScheme.EntityTitle.PluralTitle,
            DbContextNamespace = DbContextScheme.DbContextNamespace,
            DbContextName = DbContextScheme.DbContextName
        });

        var customProps = new ScriptObject();
        customProps.Import(model);

        var context = new TemplateContext();
        context.PushGlobal(baseProps);
        context.PushGlobal(customProps);

        var sourceCode = AutogeneratedFileText + "\n" + template.Render(context);
        var result = CSharpSyntaxTree.ParseText(SourceText.From(sourceCode.Trim(), Encoding.UTF8))
            .GetRoot()
            .NormalizeWhitespace()
            .SyntaxTree
            .GetText();

        Context.AddSource($"{className}.g.cs", result);
    }
}

public class EndpointMap
{
    public string EntityName { get; set; }
    public string EndpointNamespace { get; set; }
    public string HttpMethod { get; }
    public string EndpointRoute { get; set; }
    public string FunctionCall { get; set; }

    public EndpointMap(string entityName, string endpointNamespace, string httpMethod, string endpointRoute,
        string functionCall)
    {
        EntityName = entityName;
        EndpointNamespace = endpointNamespace;
        HttpMethod = httpMethod;
        EndpointRoute = endpointRoute;
        FunctionCall = functionCall;
    }
}